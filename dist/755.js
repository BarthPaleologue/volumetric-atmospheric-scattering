"use strict";(self.webpackChunkvolumetric_atmospheric_scattering=self.webpackChunkvolumetric_atmospheric_scattering||[]).push([[755],{5755:(e,t,r)=>{r.r(t),r.d(t,{_ENVTextureLoader:()=>n});var o=r(3016);class n{constructor(){this.supportCascades=!1}loadCubeData(e,t,r,n,a){if(Array.isArray(e))return;const i=(0,o.cU)(e);if(i){t.width=i.width,t.height=i.width;try{(0,o.ow)(t,i),(0,o.o5)(t,e,i).then((()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()}),(e=>{a?.("Can not upload environment levels",e)}))}catch(e){a?.("Can not upload environment file",e)}}else a&&a("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}},3016:(e,t,r)=>{r.d(t,{$h:()=>_,cU:()=>f,o5:()=>x,ow:()=>w});var o=r(2119),n=r(520),a=r(847),i=r(9026),l=r(6293),s=r(6680),u=(r(8914),r(6792)),c=r(7530);r(9463),r(4935);r(9030),r(9291);var p=r(8894);s.t.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(s.t.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=p.d.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then((e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0}))),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0}),r(9320);const d="image/png",h=2,m=[134,22,135,150,246,214,150,54];function f(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=0;for(let e=0;e<m.length;e++)if(t.getUint8(r++)!==m[e])return c.V.Error("Not a babylon environment map"),null;let o="",n=0;for(;n=t.getUint8(r++);)o+=String.fromCharCode(n);let a=JSON.parse(o);return a=y(a),a.specular&&(a.specular.specularDataPosition=r,a.specular.lodGenerationScale=a.specular.lodGenerationScale||.8),a}function y(e){if(e.version>h)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${h}".`);return 2===e.version?e:e={...e,version:2,imageType:d}}function _(e,t){const r=(t=y(t)).specular;let o=a.X.Log2(t.width);if(o=Math.round(o)+1,r.mipmaps.length!==6*o)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);const n=new Array(o);for(let t=0;t<o;t++){n[t]=new Array(6);for(let o=0;o<6;o++){const a=r.mipmaps[6*t+o];n[t][o]=new Uint8Array(e.buffer,e.byteOffset+r.specularDataPosition+a.position,a.length)}}return n}function x(e,t,n){const i=(n=y(n)).specular;return i?(e._lodGenerationScale=i.lodGenerationScale,async function(e,t,n=d){if(!o.S0.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const i=a.X.ILog2(e.width)+1,c=e.getEngine();let p=!1,h=!1,m=null,f=null,y=null;const _=c.getCaps();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,c.updateTextureSamplingMode(3,e),_.textureLOD?c._features.supportRenderAndCopyToLodForFloatTextures?_.textureHalfFloatRender&&_.textureHalfFloatLinearFiltering?(p=!0,e.type=2):_.textureFloatRender&&_.textureFloatLinearFiltering&&(p=!0,e.type=1):p=!1:(p=!1,h=!0,y={});let x=0;if(p)c.isWebGPU?(x=1,await r.e(48).then(r.bind(r,2048))):await r.e(973).then(r.bind(r,4973)),m=new u.w("rgbdDecode","rgbdDecode",null,null,1,null,3,c,!1,void 0,e.type,void 0,null,!1,void 0,x),e._isRGBD=!1,e.invertY=!1,f=c.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,h){const t=3,r=e._lodGenerationScale,o=e._lodGenerationOffset;for(let n=0;n<t;n++){const a=(i-1)*r+o,u=o+(a-o)*(1-n/(t-1)),p=Math.round(Math.min(Math.max(u,0),a)),d=new l.h(c,2);d.isCube=!0,d.invertY=!0,d.generateMipMaps=!1,c.updateTextureSamplingMode(2,d);const h=new s.t(null);switch(h._isCube=!0,h._texture=d,y[p]=h,n){case 0:e._lodTextureLow=h;break;case 1:e._lodTextureMid=h;break;case 2:e._lodTextureHigh=h}}}const w=[];for(let r=0;r<t.length;r++)for(let o=0;o<6;o++){const a=t[r][o],i=new Blob([a],{type:n}),l=URL.createObjectURL(i);let s;if(c._features.forceBitmapOverHTMLImageElement)s=c.createImageBitmap(i,{premultiplyAlpha:"none"}).then((t=>g(t,c,p,m,l,o,r,h,y,f,e)));else{const t=new Image;t.src=l,s=new Promise(((n,a)=>{t.onload=()=>{g(t,c,p,m,l,o,r,h,y,f,e).then((()=>n())).catch((e=>{a(e)}))},t.onerror=e=>{a(e)}}))}w.push(s)}if(t.length<i){let r;const o=Math.pow(2,i-1-t.length),n=o*o*4;switch(e.type){case 0:r=new Uint8Array(n);break;case 2:r=new Uint16Array(n);break;case 1:r=new Float32Array(n)}for(let o=t.length;o<i;o++)for(let t=0;t<6;t++)c._uploadArrayBufferViewToTexture(e,r,t,o)}return Promise.all(w).then((()=>{f&&(c._releaseTexture(e),f._swapAndDie(e)),m&&m.dispose(),h&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}))}(e,_(t,n),n.imageType)):Promise.resolve()}function g(e,t,r,o,n,a,i,l,s,u,c){return new Promise(((p,d)=>{if(r){const r=t.createTexture(null,!0,!0,null,1,null,(e=>{d(e)}),e);o?.onEffectCreatedObservable.addOnce((l=>{l.executeWhenCompiled((()=>{o.externalTextureSamplerBinding=!0,o.onApply=o=>{o._bindTexture("textureSampler",r),o.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([o],u,!0,a,i),t.restoreDefaultFramebuffer(),r.dispose(),URL.revokeObjectURL(n),p())}))}))}else{if(t._uploadImageToTexture(c,e,a,i),l){const r=s[i];r&&t._uploadImageToTexture(r._texture,e,a,0)}p()}}))}function w(e,t){const r=(t=y(t)).irradiance;if(!r)return;const o=new i.Q;n.Pq.FromArrayToRef(r.x,0,o.x),n.Pq.FromArrayToRef(r.y,0,o.y),n.Pq.FromArrayToRef(r.z,0,o.z),n.Pq.FromArrayToRef(r.xx,0,o.xx),n.Pq.FromArrayToRef(r.yy,0,o.yy),n.Pq.FromArrayToRef(r.zz,0,o.zz),n.Pq.FromArrayToRef(r.yz,0,o.yz),n.Pq.FromArrayToRef(r.zx,0,o.zx),n.Pq.FromArrayToRef(r.xy,0,o.xy),e._sphericalPolynomial=o}}}]);