"use strict";(self.webpackChunkvolumetric_atmospheric_scattering=self.webpackChunkvolumetric_atmospheric_scattering||[]).push([[355],{7355:(e,t,r)=>{r.r(t),r.d(t,{_ENVTextureLoader:()=>x});var o=r(2119),n=r(520),a=r(847),i=r(9026),l=r(6293),s=r(6680),u=(r(8914),r(6792)),p=r(7530);r(9463),r(4935);r(9030),r(9291);var c=r(8894);s.t.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(s.t.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=c.d.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then((e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0}))),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0}),r(9320);const d="image/png",h=2,m=[134,22,135,150,246,214,150,54];function f(e){if(e.version>h)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${h}".`);return 2===e.version?e:e={...e,version:2,imageType:d}}function y(e,t,n){const i=(n=f(n)).specular;return i?(e._lodGenerationScale=i.lodGenerationScale,async function(e,t,n=d){if(!o.S0.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const i=a.X.ILog2(e.width)+1,p=e.getEngine();let c=!1,h=!1,m=null,f=null,y=null;const x=p.getCaps();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,p.updateTextureSamplingMode(3,e),x.textureLOD?p._features.supportRenderAndCopyToLodForFloatTextures?x.textureHalfFloatRender&&x.textureHalfFloatLinearFiltering?(c=!0,e.type=2):x.textureFloatRender&&x.textureFloatLinearFiltering&&(c=!0,e.type=1):c=!1:(c=!1,h=!0,y={});let g=0;if(c)p.isWebGPU?(g=1,await r.e(48).then(r.bind(r,2048))):await r.e(973).then(r.bind(r,4973)),m=new u.w("rgbdDecode","rgbdDecode",null,null,1,null,3,p,!1,void 0,e.type,void 0,null,!1,void 0,g),e._isRGBD=!1,e.invertY=!1,f=p.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,h){const t=3,r=e._lodGenerationScale,o=e._lodGenerationOffset;for(let n=0;n<t;n++){const a=(i-1)*r+o,u=o+(a-o)*(1-n/(t-1)),c=Math.round(Math.min(Math.max(u,0),a)),d=new l.h(p,2);d.isCube=!0,d.invertY=!0,d.generateMipMaps=!1,p.updateTextureSamplingMode(2,d);const h=new s.t(null);switch(h._isCube=!0,h._texture=d,y[c]=h,n){case 0:e._lodTextureLow=h;break;case 1:e._lodTextureMid=h;break;case 2:e._lodTextureHigh=h}}}const w=[];for(let r=0;r<t.length;r++)for(let o=0;o<6;o++){const a=t[r][o],i=new Blob([a],{type:n}),l=URL.createObjectURL(i);let s;if(p._features.forceBitmapOverHTMLImageElement)s=p.createImageBitmap(i,{premultiplyAlpha:"none"}).then((t=>_(t,p,c,m,l,o,r,h,y,f,e)));else{const t=new Image;t.src=l,s=new Promise(((n,a)=>{t.onload=()=>{_(t,p,c,m,l,o,r,h,y,f,e).then((()=>n())).catch((e=>{a(e)}))},t.onerror=e=>{a(e)}}))}w.push(s)}if(t.length<i){let r;const o=Math.pow(2,i-1-t.length),n=o*o*4;switch(e.type){case 0:r=new Uint8Array(n);break;case 2:r=new Uint16Array(n);break;case 1:r=new Float32Array(n)}for(let o=t.length;o<i;o++)for(let t=0;t<6;t++)p._uploadArrayBufferViewToTexture(e,r,t,o)}return Promise.all(w).then((()=>{f&&(p._releaseTexture(e),f._swapAndDie(e)),m&&m.dispose(),h&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}))}(e,function(e,t){const r=(t=f(t)).specular;let o=a.X.Log2(t.width);if(o=Math.round(o)+1,r.mipmaps.length!==6*o)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);const n=new Array(o);for(let t=0;t<o;t++){n[t]=new Array(6);for(let o=0;o<6;o++){const a=r.mipmaps[6*t+o];n[t][o]=new Uint8Array(e.buffer,e.byteOffset+r.specularDataPosition+a.position,a.length)}}return n}(t,n),n.imageType)):Promise.resolve()}function _(e,t,r,o,n,a,i,l,s,u,p){return new Promise(((c,d)=>{if(r){const r=t.createTexture(null,!0,!0,null,1,null,(e=>{d(e)}),e);o?.onEffectCreatedObservable.addOnce((l=>{l.executeWhenCompiled((()=>{o.externalTextureSamplerBinding=!0,o.onApply=o=>{o._bindTexture("textureSampler",r),o.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([o],u,!0,a,i),t.restoreDefaultFramebuffer(),r.dispose(),URL.revokeObjectURL(n),c())}))}))}else{if(t._uploadImageToTexture(p,e,a,i),l){const r=s[i];r&&t._uploadImageToTexture(r._texture,e,a,0)}c()}}))}class x{constructor(){this.supportCascades=!1}loadCubeData(e,t,r,o,a){if(Array.isArray(e))return;const l=function(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=0;for(let e=0;e<m.length;e++)if(t.getUint8(r++)!==m[e])return p.V.Error("Not a babylon environment map"),null;let o="",n=0;for(;n=t.getUint8(r++);)o+=String.fromCharCode(n);let a=JSON.parse(o);return a=f(a),a.specular&&(a.specular.specularDataPosition=r,a.specular.lodGenerationScale=a.specular.lodGenerationScale||.8),a}(e);if(l){t.width=l.width,t.height=l.width;try{(function(e,t){const r=(t=f(t)).irradiance;if(!r)return;const o=new i.Q;n.Pq.FromArrayToRef(r.x,0,o.x),n.Pq.FromArrayToRef(r.y,0,o.y),n.Pq.FromArrayToRef(r.z,0,o.z),n.Pq.FromArrayToRef(r.xx,0,o.xx),n.Pq.FromArrayToRef(r.yy,0,o.yy),n.Pq.FromArrayToRef(r.zz,0,o.zz),n.Pq.FromArrayToRef(r.yz,0,o.yz),n.Pq.FromArrayToRef(r.zx,0,o.zx),n.Pq.FromArrayToRef(r.xy,0,o.xy),e._sphericalPolynomial=o})(t,l),y(t,e,l).then((()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),o&&o()}),(e=>{a?.("Can not upload environment levels",e)}))}catch(e){a?.("Can not upload environment file",e)}}else a&&a("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}}}]);